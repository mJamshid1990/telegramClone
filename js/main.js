let ism = "Jamshid";
let familiya = "Maxmudov";

let DATA = {
  people: [
    {
      id: 1,
      first_name: "Anvar",
      last_name: "Narzullayev",
      avatar: [
        "https://www.google.com/imgres?imgurl=https%3A%2F%2Fi.ytimg.com%2Fvi%2FN_DpQtz5ZR4%2Fmaxresdefault.jpg&imgrefurl=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DN_DpQtz5ZR4&tbnid=Eg-lbcNOQE81YM&vet=12ahUKEwiu1om-w5X4AhWExosKHZA3DlQQMygNegUIARCEAQ..i&docid=i9C1y56pvYUcNM&w=1280&h=720&q=anvar%20narzullayev&ved=2ahUKEwiu1om-w5X4AhWExosKHZA3DlQQMygNegUIARCEAQ",
        "https://www.google.com/imgres?imgurl=https%3A%2F%2Fi.ytimg.com%2Fvi%2FN_DpQtz5ZR4%2Fmaxresdefault.jpg&imgrefurl=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DN_DpQtz5ZR4&tbnid=Eg-lbcNOQE81YM&vet=12ahUKEwiu1om-w5X4AhWExosKHZA3DlQQMygNegUIARCEAQ..i&docid=i9C1y56pvYUcNM&w=1280&h=720&q=anvar%20narzullayev&ved=2ahUKEwiu1om-w5X4AhWExosKHZA3DlQQMygNegUIARCEAQ#imgrc=Eg-lbcNOQE81YM&imgdii=1W8p1cV2ZFdcmM",
        "https://www.google.com/imgres?imgurl=https%3A%2F%2Fi.ytimg.com%2Fvi%2FN_DpQtz5ZR4%2Fmaxresdefault.jpg&imgrefurl=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DN_DpQtz5ZR4&tbnid=Eg-lbcNOQE81YM&vet=12ahUKEwiu1om-w5X4AhWExosKHZA3DlQQMygNegUIARCEAQ..i&docid=i9C1y56pvYUcNM&w=1280&h=720&q=anvar%20narzullayev&ved=2ahUKEwiu1om-w5X4AhWExosKHZA3DlQQMygNegUIARCEAQ#imgrc=1W8p1cV2ZFdcmM&imgdii=t2POGWm0AyYS6M",
        "https://www.google.com/imgres?imgurl=https%3A%2F%2Flookaside.fbsbx.com%2Flookaside%2Fcrawler%2Fmedia%2F%3Fmedia_id%3D872023573473499&imgrefurl=https%3A%2F%2Fne-np.facebook.com%2Fnajottalim%2Fposts%2Fuzoq-kutilgan-master-klass-anvar-narzulloh-bilankoplab-taklif-va-talablarni-inob%2F872024233473433%2F&tbnid=iaDV-VvfHqMYJM&vet=12ahUKEwiu1om-w5X4AhWExosKHZA3DlQQMygiegUIARCyAQ..i&docid=wtjamX5_CbVuiM&w=1440&h=1440&q=anvar%20narzullayev&ved=2ahUKEwiu1om-w5X4AhWExosKHZA3DlQQMygiegUIARCyAQ#imgrc=iaDV-VvfHqMYJM&imgdii=t6usRSNGGR8gtM",
      ],
      bio: "python, sun'iy intellect, mohirdev.uz",
      phone_number: "+99800 000 00 00",
      user_name: "@sariqdev",
      groups_common: 4,
      shared_links: 15,
      shared_files: 1,
      shared_photos: 20,
      shared_voice: 15,
      activity: "online",
      messages: [
        {
          id: 1,
          is_from_me: false,
          text: "Hello",
          time: new Date(2021, 7, 16, 11, 10, 05).getTime(),
        },
        {
          id: 2,
          is_from_me: true,
          text: "Hi",
          time: new Date(2021, 7, 16, 11, 11, 10).getTime(),
        },
        {
          id: 3,
          is_from_me: false,
          text: "How are you ?",
          time: new Date(2021, 7, 16, 11, 11, 15).getTime(),
        },
        {
          id: 4,
          is_from_me: true,
          text: "üôÇ and you ?",
          time: new Date(2021, 7, 16, 11, 12, 50).getTime(),
        },
      ],
    },
    {
      id: 2,
      first_name: "Saidbek",
      last_name: "Arislonov",
      avatar: [
        "https://www.google.com/imgres?imgurl=https%3A%2F%2Fstorage.kun.uz%2Fsource%2F6%2FYg2eaAPcNUad6YPLHKR4LHPwWmrxQTr8.jpg&imgrefurl=https%3A%2F%2Fkun.uz%2Fru%2Fnews%2F2021%2F01%2F31%2Fot-pomoshchnika-ofitsianta-do-senior-programmista-beseda-s-uzbekskim-parnem-rabotayushchim-v-mastercard&tbnid=3DLOcG1I6lOUWM&vet=12ahUKEwjU-Pa63ZX4AhUMzCoKHZ4cBDIQMygCegQIARBL..i&docid=zLCADuGhTArgFM&w=834&h=515&q=saidbek%20arislonov&ved=2ahUKEwjU-Pa63ZX4AhUMzCoKHZ4cBDIQMygCegQIARBL",
        "https://www.google.com/imgres?imgurl=https%3A%2F%2Fstorage.kun.uz%2Fsource%2F6%2FYg2eaAPcNUad6YPLHKR4LHPwWmrxQTr8.jpg&imgrefurl=https%3A%2F%2Fkun.uz%2Fru%2Fnews%2F2021%2F01%2F31%2Fot-pomoshchnika-ofitsianta-do-senior-programmista-beseda-s-uzbekskim-parnem-rabotayushchim-v-mastercard&tbnid=3DLOcG1I6lOUWM&vet=12ahUKEwjU-Pa63ZX4AhUMzCoKHZ4cBDIQMygCegQIARBL..i&docid=zLCADuGhTArgFM&w=834&h=515&q=saidbek%20arislonov&ved=2ahUKEwjU-Pa63ZX4AhUMzCoKHZ4cBDIQMygCegQIARBL#imgrc=3DLOcG1I6lOUWM&imgdii=yBHfN7rIJPGIHM",
      ],
      bio: "java script, selecon valley",
      phone_number: "+99800 123 45 67",
      user_name: "@s_arislonov",
      groups_common: 3,
      shared_links: 11,
      shared_files: 1,
      shared_photos: 15,
      shared_voice: 10,
      activity: "Last seen today at 10:01 AM",
      messages: [
        {
          id: 1,
          is_from_me: false,
          text: "Salomatmisiz",
          time: new Date(2021, 7, 16, 11, 10, 05).getTime(),
        },
        {
          id: 2,
          is_from_me: true,
          text: "Rahmat o'ziz qaleysiz",
          time: new Date(2021, 7, 16, 11, 11, 10).getTime(),
        },
      ],
    },
  ],

  groups: [
    {
      id: 1,
      name: "Backend-20",
      avatar: [],
      bio: "JS ga asoslangan beckend kursi",
      user_name: "@nodeJs",
      members: 7,
      shared_links: 15,
      shared_files: 16,
      shared_photos: 16,
      shared_voice: 0,
      shared_videos: 11,
      activity: " members, 2 online",
      messages: [
        {
          id: 1,
          is_from_me: false,
          text: "lorem ipsum dolor sit amet...",
          time: new Date(2021, 8, 1, 11, 11, 11).getTime(),
        },
        {
          id: 2,
          is_from_me: true,
          text: "Lorem, ipsum dolor sit amet consectetur adipisicing elit. Molestias error fuga possimus cum, ab animi quaerat autem omnis fugiat mollitia delectus perferendis quo, placeat, quis totam maxime quae voluptatem esse?",
          time: new Date(2021, 8, 1, 11, 11, 50).getTime(),
        },
      ],
    },
  ],
  channels: [
    {
      id: 1,
      name: "Art-Kokand",
      avatar: [
        "https://www.google.com/imgres?imgurl=https%3A%2F%2Fstatic10.tgstat.ru%2Fchannels%2F_0%2F0b%2F0b012b9f451776131e5287874717f82a.jpg&imgrefurl=https%3A%2F%2Ftgstat.com%2Fru%2Fchannel%2F%40artschoolkokand&tbnid=CIuSbZhMeY16JM&vet=12ahUKEwii77rC35X4AhXJvCoKHU0pA2oQMygAegUIARDCAQ..i&docid=KobpOHdUy69-RM&w=640&h=640&itg=1&q=art-kokand&ved=2ahUKEwii77rC35X4AhXJvCoKHU0pA2oQMygAegUIARDCAQ",
      ],
      bio: `
      Mazkur kanal Q√µqon ixtisoslashtirilgan san'at maktabi uchun maxsus yaratilgan b√µlib, bunda maktabda √µtkazilgan tadbirlar, yangiliklar hamda topshiriqlar muntazam yoritib boriladi.
      `,
      user_name: "@artschoolkokand",
      members: 506,
      shared_links: 94,
      shared_files: 1,
      shared_photos: 72,
      shared_voice: 3,
      shared_videos: 9,
      activity: " subscribers",
      messages: [
        {
          id: 1,
          is_from_me: false,
          text: "lorem ipsum dolor sit amet...",
          time: new Date(2021, 8, 1, 11, 11, 11).getTime(),
        },
        {
          id: 2,
          is_from_me: false,
          text: "lorem ipsum dolor sit amet...",
          time: new Date(2021, 8, 2, 11, 11, 11).getTime(),
        },
      ],
    },
  ],
  bots: [
    {
      id: 1,
      name: "VKM Bot",
      avatar: [
        "https://botostore.com/netcat_files/22/26/preview_26957_1542499501.jpg",
        "https://picsum.photos/500/384",
      ],
      bio: `
            Listen to and download any music!
            Contact & Ads: @vkmowner
            Our media: @vekaem`,
      user_name: "@vkm_bot",
      shared_links: 22,
      shared_files: 0,
      shared_photos: 0,
      shared_voice: 417,
      activity: "bot",
      messages: [
        {
          id: 1,
          is_from_me: false,
          text: "lorem ipsum dolor sit amet...",
          time: new Date(2021, 8, 1, 11, 11, 11).getTime(),
        },
        {
          id: 2,
          is_from_me: true,
          text: "Mustafa Ceceli",
          time: new Date(2021, 8, 1, 11, 11, 11).getTime(),
        },
      ],
    },
  ],
  me: [
    {
      first_name: ism,
      last_name: familiya,
      avatar: ["https://picsum.photos/500/400"],
      bio: `Yaratganga shukur`,
      phone_number: "+99 890 588 99 10",
      user_name: "@jamshidartschool",
      shared_links: 20,
      shared_files: 30,
      shared_photos: 40,
      shared_voice: 0,
      activity: "Online",
      messages: [
        {
          id: 1,
          is_from_me: true,
          text: "lorem ipsum dolor sit amet...",
          time: new Date(2021, 8, 1, 11, 11, 11).getTime(),
        },
        {
          id: 2,
          is_from_me: true,
          text: "Lorem ipsum",
          time: new Date(2021, 8, 1, 11, 11, 11).getTime(),
        },
      ],
    },
    {
      first_name: "Please select any chat to start messaging",
      last_name: "",
      avatar: [
        "https://res.cloudinary.com/jerrick/image/upload/v1613548658/602ccc72b2f2e2001df1a885.png",
      ],
      bio: ``,
      phone_number: "not available",
      user_name: "@deleted_account",
      shared_links: 0,
      shared_files: 0,
      shared_photos: 0,
      shared_voice: 0,
      shared_videos: 0,
      activity: "Last seen a long time ago",
      messages: [
        {
          id: 1,
          is_from_me: false,
          is_service_notifications: true,
          text: "This account has just been deleted",
          time: new Date().getTime(),
        },
      ],
    },
  ],
};

!localStorage.getItem("DATA") &&
  localStorage.setItem("DATA", JSON.stringify(DATA));

let weekDays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
let selected_chat_username;
let selected_chatlist;
let is_searching_messages = false;

KEYBOARD_PACK = {
  first_line: [
    {
      key: "`",
      shift: "~",
      cyrill: "—ë",
      cyrill_shift: "–Å",
    },
    {
      key: "1",
      shift: "!",
      cyrill: "1",
      cyrill_shift: "!",
    },
    {
      key: "2",
      shift: "@",
      cyrill: "2",
      cyrill_shift: '"',
    },
    {
      key: "3",
      shift: "#",
      cyrill: "3",
      cyrill_shift: "‚Ññ",
    },
    {
      key: "4",
      shift: "$",
      cyrill: "4",
      cyrill_shift: ";",
    },
    {
      key: "5",
      shift: "%",
      cyrill: "5",
      cyrill_shift: "%",
    },
    {
      key: "6",
      shift: "^",
      cyrill: "6",
      cyrill_shift: ":",
    },
    {
      key: "7",
      shift: "&",
      cyrill: "7",
      cyrill_shift: "?",
    },
    {
      key: "8",
      shift: "*",
      cyrill: "8",
      cyrill_shift: "*",
    },
    {
      key: "9",
      shift: "(",
      cyrill: "9",
      cyrill_shift: "(",
    },
    {
      key: "0",
      shift: ")",
      cyrill: "0",
      cyrill_shift: ")",
    },
    {
      key: "-",
      shift: "_",
      cyrill: "-",
      cyrill_shift: "_",
    },
    {
      key: "=",
      shift: "+",
      cyrill: "=",
      cyrill_shift: "+",
    },
    {
      key: "Back",
      shift: false,
    },
  ],
  second_line: [
    {
      key: "Tab",
      shift: false,
    },
    {
      key: "q",
      shift: "Q",
      cyrill: "–π",
      cyrill_shift: "–ô",
    },
    {
      key: "w",
      shift: "W",
      cyrill: "—Ü",
      cyrill_shift: "–¶",
    },
    {
      key: "e",
      shift: "E",
      cyrill: "—É",
      cyrill_shift: "–£",
    },
    {
      key: "r",
      shift: "R",
      cyrill: "–∫",
      cyrill_shift: "–ö",
    },
    {
      key: "t",
      shift: "T",
      cyrill: "–µ",
      cyrill_shift: "–ï",
    },
    {
      key: "y",
      shift: "Y",
      cyrill: "–Ω",
      cyrill_shift: "–ù",
    },
    {
      key: "u",
      shift: "U",
      cyrill: "–≥",
      cyrill_shift: "–ì",
    },
    {
      key: "i",
      shift: "I",
      cyrill: "—à",
      cyrill_shift: "–®",
    },
    {
      key: "o",
      shift: "O",
      cyrill: "—â",
      cyrill_shift: "–©",
    },
    {
      key: "p",
      shift: "P",
      cyrill: "–∑",
      cyrill_shift: "–ó",
    },
    {
      key: "[",
      shift: "{",
      cyrill: "—Ö",
      cyrill_shift: "–•",
    },
    {
      key: "]",
      shift: "}",
      cyrill: "—ä",
      cyrill_shift: "–™",
    },
    {
      key: "\\",
      shift: "|",
      cyrill: "\\",
      cyrill_shift: "/",
    },
  ],
  third_line: [
    {
      key: "Caps",
      shift: false,
    },
    {
      key: "a",
      shift: "A",
      cyrill: "—Ñ",
      cyrill_shift: "–§",
    },
    {
      key: "s",
      shift: "S",
      cyrill: "—ã",
      cyrill_shift: "–´",
    },
    {
      key: "d",
      shift: "D",
      cyrill: "–≤",
      cyrill_shift: "–í",
    },
    {
      key: "f",
      shift: "F",
      cyrill: "–∞",
      cyrill_shift: "–ê",
    },
    {
      key: "g",
      shift: "G",
      cyrill: "–ø",
      cyrill_shift: "–ü",
    },
    {
      key: "h",
      shift: "H",
      cyrill: "—Ä",
      cyrill_shift: "–†",
    },
    {
      key: "j",
      shift: "J",
      cyrill: "–æ",
      cyrill_shift: "–û",
    },
    {
      key: "k",
      shift: "K",
      cyrill: "–ª",
      cyrill_shift: "–õ",
    },
    {
      key: "l",
      shift: "L",
      cyrill: "–¥",
      cyrill_shift: "–î",
    },
    {
      key: ";",
      shift: ":",
      cyrill: "–∂",
      cyrill_shift: "–ñ",
    },
    {
      key: "'",
      shift: '"',
      cyrill: "—ç",
      cyrill_shift: "–≠",
    },
    {
      key: "Enter",
      shift: false,
    },
  ],
  fourth_line: [
    {
      key: "Shift",
      shift: false,
    },
    {
      key: "z",
      shift: "Z",
      cyrill: "—è",
      cyrill_shift: "–Ø",
    },
    {
      key: "x",
      shift: "X",
      cyrill: "—á",
      cyrill_shift: "–ß",
    },
    {
      key: "c",
      shift: "C",
      cyrill: "—Å",
      cyrill_shift: "–°",
    },
    {
      key: "v",
      shift: "V",
      cyrill: "–º",
      cyrill_shift: "–ú",
    },
    {
      key: "b",
      shift: "B",
      cyrill: "–∏",
      cyrill_shift: "–ò",
    },
    {
      key: "n",
      shift: "N",
      cyrill: "—Ç",
      cyrill_shift: "–¢",
    },
    {
      key: "m",
      shift: "M",
      cyrill: "—å",
      cyrill_shift: "–¨",
    },
    {
      key: ",",
      shift: "<",
      cyrill: "–±",
      cyrill_shift: "–ë",
    },
    {
      key: ".",
      shift: ">",
      cyrill: "—é",
      cyrill_shift: "–Æ",
    },
    {
      key: "/",
      shift: "?",
      cyrill: ".",
      cyrill_shift: ",",
    },
    {
      key: "Shift",
      shift: false,
    },
  ],
};

document.querySelector("#search").addEventListener("focus", () => {
  document.querySelector(".search-wrapper").style.border = "2px solid #3390ec";
  document.querySelector(".fa-search").style.color = "#3390ec";
  document.querySelector(".clear-search-btn").style.opacity = "1";
});
document.querySelector("#search").addEventListener("blur", () => {
  document.querySelector(".search-wrapper").style.border = "1px solid #dfe1e5";
  document.querySelector(".fa-search").style.color = "#dfe1e5";
  document.querySelector(".clear-search-btn").style.opacity = "0";
});

document.querySelector("#search").addEventListener("keyup", (e) => {
  let excluded_keys = [18, 20, 17, 16, 9]; //Alt, Caps Lock, Ctrl, Shift, tab

  if (!excluded_keys.includes(e.keyCode)) {
    //exclude keys above

    let search_for = new RegExp(e.target.value, "gi");

    if (is_searching_messages) {
      // if searching messages

      let DATA_from_local_storage = JSON.parse(localStorage.getItem("DATA"));
      let where_to_render = `#${document
        .querySelector(".navbar li.active")
        .getAttribute("data-target")}`;
      // render new chatlist related to search query
      Object.keys(DATA_from_local_storage).forEach((tab) => {
        DATA_from_local_storage[tab].forEach((individ) => {
          if (individ.user_name === selected_chat_username) {
            document.querySelector(`${where_to_render}`).innerHTML = ""; //cleaning output area

            individ.messages.forEach((message, index, arr) => {
              if (search_for.test(message.text)) {
                document.querySelector(`${where_to_render}`).innerHTML += `
                                <div class="chat_item" onClick="fill_middle_column(this)" data-username="${
                                  individ.user_name
                                }">
                                    <div class="chat_avatar">
                                        <img src="${
                                          individ.avatar[0]
                                            ? individ.avatar[0]
                                            : "https://icon-library.com/images/no-profile-picture-icon/no-profile-picture-icon-11.jpg"
                                        }" alt="avatar">
                                    </div>
                                    <div class="user_caption">
                                        <div class="diolog_title">
                                            <p>${
                                              individ.first_name
                                                ? individ.first_name
                                                : individ.name
                                            } ${
                  individ.last_name ? individ.last_name : ""
                }</p>
                                            <div class="diolog_title_details">
                                                <i class="fa fa-check message_status" aria-hidden="true"></i>
                                                <span class="message_time">${
                                                  weekDays[
                                                    new Date(
                                                      message.time
                                                    ).getDay()
                                                  ]
                                                }</span>
                                            </div>
                                        </div>
                                        <div class="dialog_subtitle">
                                            <p message_id="${message.id}">${
                  message.text
                }</p>
                                            <div class="diolog_subtitle_details">
                                                <span class="unread_message_count">${
                                                  index === arr.length - 1
                                                    ? message.is_from_me
                                                      ? ""
                                                      : 1
                                                    : ""
                                                }</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>`;
              }
            });
          }
        });
      });
    } else {
      //if searching chats
      let search_list =
        "#" +
        document
          .querySelector(".navbar li.active")
          .getAttribute("data-target") +
        " .diolog_title p";

      document.querySelectorAll(`${search_list}`).forEach((item) => {
        if (search_for.test(item.textContent)) {
          item.parentElement.parentElement.parentElement.style.display = "grid";
        } else {
          item.parentElement.parentElement.parentElement.style.display = "none";
        }
      });
    }
  }
});

// clear search input button
document.querySelector(".clear-search-btn").addEventListener("click", () => {
  document.querySelector("#search").value = "";
  document.querySelector("#search").focus();

  if (is_searching_messages) {
    //if message search finished, re-render original chatlist
    let where_to_render = `${document
      .querySelector(".navbar li.active")
      .getAttribute("data-target")}`;
    fill_left_column(where_to_render);
    is_searching_messages = false;
  } else {
    //if chat search finished, restore all chats' display:grid style
    let search_list =
      "#" +
      document.querySelector(".navbar li.active").getAttribute("data-target") +
      " .diolog_title p";
    document.querySelectorAll(`${search_list}`).forEach((item) => {
      item.parentElement.parentElement.parentElement.style.display = "grid";
    });
  }
});

// ///SETTINGS///
// toggle settings window
document.querySelector(".toggle-settings").addEventListener("click", () => {
  document.querySelector(".settings").classList.toggle("hide");
});
// new group
document.querySelector("#new_group").addEventListener("click", () => {
  document.querySelector(".new_group_modal").classList.toggle("active");
  document.querySelector(".settings").classList.add("hide");
});
document.querySelector("#column-center").addEventListener("click", (e) => {
  document.querySelector(".settings").classList.add("hide");
});
document.querySelectorAll(".check_for_uniqueness").forEach((each) => {
  each.addEventListener("keyup", (e) => {
    let unique_id_warning = false;
    let DATA_from_local_storage = JSON.parse(localStorage.getItem("DATA"));
    Object.keys(DATA_from_local_storage).forEach((tab) => {
      DATA_from_local_storage[tab].forEach((individ) => {
        if (individ.user_name === e.target.value) {
          unique_id_warning = true;
        }
      });
    });
    if (unique_id_warning) {
      document.querySelectorAll(".unique_id_warning").forEach((each) => {
        each.classList.add("show");
      });
    } else {
      document.querySelectorAll(".unique_id_warning").forEach((each) => {
        each.classList.remove("show");
      });
    }
  });
});
// new channel
document.querySelector("#new_channel").addEventListener("click", () => {
  document.querySelector(".new_channel_modal").classList.toggle("active");
  document.querySelector(".settings").classList.add("hide");
});
// saved messages
document.querySelector("#saved_messages").addEventListener("click", (e) => {
  document.querySelector(".settings").classList.add("hide");

  // TO LEFT COLUMN
  document.querySelectorAll(".navbar li").forEach((elem) => {
    elem.classList.remove("active");
  });
  document.querySelector(`[data-target="all_chats"]`).classList.add("active");
  document.querySelectorAll(".tabs-content").forEach((elem) => {
    elem.classList.remove("active");
    elem.innerHTML = ""; // qolgan tab larni ichini tozalaydi
  });
  document.querySelector(`#all_chats`).classList.add("active");
  fill_left_column("all_chats");

  // TO MIDDLE COLUMN
  fill_middle_column(
    document.querySelector("#all_chats").lastElementChild.previousElementSibling
  );
  // TO RIGHT COLUMN
  fill_right_column();
});

// chat-tabs navigation match
document.querySelectorAll(".navbar li").forEach((elem) => {
  // INITIATE FIRST RENDER on active tab
  selected_chatlist = document
    .querySelector(".navbar li.active")
    .getAttribute("data-target");
  fill_left_column(selected_chatlist);
  // next render according to click
  elem.addEventListener("click", (e) => {
    selected_chatlist = e.target.getAttribute("data-target");

    // toggle .active on tabs
    document.querySelectorAll(".navbar li").forEach((elem) => {
      elem.classList.remove("active");
    });
    e.target.classList.add("active");

    // corresponding tabs will be shown
    document.querySelectorAll(".tabs-content").forEach((elem) => {
      elem.classList.remove("active");
      elem.innerHTML = ""; // qolgan tab larni ichini tozalaydi
    });
    document.querySelector(`#${selected_chatlist}`).classList.add("active");
    // tanlangan chat ni ichini kontent bilan to'ldiradi
    fill_left_column(selected_chatlist);
  });
});

// renders DATA to left column
function fill_left_column(location) {
  let DATA_from_local_storage = JSON.parse(localStorage.getItem("DATA"));
  // render qilishdan avval tozalab olsinchi:
  document.querySelector(`#${location}`).innerHTML = "";

  if (location === "all_chats") {
    for (let i in DATA_from_local_storage) {
      DATA_from_local_storage[i].forEach((item) => {
        // if you have ever interacted with this user
        if (item.messages.length !== 0) {
          document.querySelector(`#${location}`).innerHTML += `
                <div class="chat_item" onClick="fill_middle_column(this)" data-username="${
                  item.user_name
                }">
                    <div class="chat_avatar">
                        <img src="${
                          item.avatar[0]
                            ? item.avatar[0]
                            : "https://icon-library.com/images/no-profile-picture-icon/no-profile-picture-icon-11.jpg"
                        }" alt="avatar">
                    </div>
                    <div class="user_caption">
                        <div class="diolog_title">
                            <p>${
                              item.first_name ? item.first_name : item.name
                            } ${item.last_name ? item.last_name : ""}</p>
                            <div class="diolog_title_details">
                                <i class="fa fa-check message_status" aria-hidden="true"></i>
                                <span class="message_time">${
                                  weekDays[
                                    new Date(
                                      item.messages[
                                        item.messages.length - 1
                                      ].time
                                    ).getDay()
                                  ]
                                }</span>
                            </div>
                        </div>
                        <div class="dialog_subtitle">
                            <p message_id="${
                              item.messages[item.messages.length - 1].id
                            }">${
            item.messages[item.messages.length - 1].text
          }</p>
                            <div class="diolog_subtitle_details">
                                <span class="unread_message_count">${
                                  item.messages[item.messages.length - 1]
                                    .is_from_me
                                    ? ""
                                    : item.messages[item.messages.length - 1]
                                        .is_service_notifications
                                    ? ""
                                    : 1
                                }</span>
                            </div>
                        </div>
                    </div>
                </div>
                    `;
        }
      });
    }
  } else {
    //one location for one tab
    DATA_from_local_storage[location].forEach((item) => {
      // if you have ever interacted with this user
      if (item.messages.length !== 0) {
        document.querySelector(`#${location}`).innerHTML += `
            <div class="chat_item" onClick="fill_middle_column(this)" data-username="${
              item.user_name
            }">
                <div class="chat_avatar">
                    <img src="${
                      item.avatar[0]
                        ? item.avatar[0]
                        : "https://simg.nicepng.com/png/small/930-9302865_notes-from-reasons-to-conference-brighton-whatsapp-profile.png"
                    }" alt="avatar">
                </div>
                <div class="user_caption">
                    <div class="diolog_title">
                        <p>${item.first_name ? item.first_name : item.name} ${
          item.last_name ? item.last_name : ""
        }</p>
                        <div class="diolog_title_details">
                            <i class="fa fa-check message_status" aria-hidden="true"></i>
                            <span class="message_time">${
                              weekDays[
                                new Date(
                                  item.messages[item.messages.length - 1].time
                                ).getDay()
                              ]
                            }</span>
                        </div>
                    </div>
                    <div class="dialog_subtitle">
                        <p message_id="${
                          item.messages[item.messages.length - 1].id
                        }">${item.messages[item.messages.length - 1].text}</p>
                        <div class="diolog_subtitle_details">
                            <span class="unread_message_count">${
                              item.messages[item.messages.length - 1].is_from_me
                                ? ""
                                : item.messages[item.messages.length - 1]
                                    .is_service_notifications
                                ? ""
                                : 1
                            }</span>
                        </div>

                    </div>
                </div>
            </div>
                `;
      }
    });
  }
}

////////////////////////////////////////////MIDDLE COLUMN//////////////////////////////////////////////////////////

// renders DATA to middle column and adds related functionality like search and newMessage input
function fill_middle_column(what) {
  // /////////////////////////////////MEDIA////////////////////////////////////////
  if (screen.width < 700) {
    document
      .querySelector("#telegram")
      .setAttribute("style", "grid-template-columns: 100% 0 !important;");
    document.querySelector("#column-left").style.display = "none";
    document.querySelector("#column-center").classList.remove("shrinked");
    document.querySelector("#column-right").classList.remove("expanded");
  }
  let DATA_from_local_storage = JSON.parse(localStorage.getItem("DATA"));
  let message_to_show =
    what.lastElementChild.lastElementChild.firstElementChild.getAttribute(
      "message_id"
    );

  // if one chat is selected, show new message input (main-footer)
  document.querySelector(".main-footer").style.display = "block";

  //tanlangan userning id(username) sini saqlab qo'ymoqda
  selected_chat_username = what.getAttribute("data-username");
  // chats and middle-navbar rendering
  for (let tabs in DATA_from_local_storage) {
    DATA_from_local_storage[tabs].forEach((chatItem) => {
      if (chatItem.user_name === selected_chat_username) {
        // change avatar
        document.querySelector("#avatar").src = `${
          chatItem.avatar[0]
            ? chatItem.avatar[0]
            : "https://picsum.photos/500/400"
        }`;
        // change name
        document.querySelector("#name").innerHTML = `${
          chatItem.first_name ? chatItem.first_name : chatItem.name
        } ${chatItem.last_name ? chatItem.last_name : ""}`;
        // change status
        if (chatItem.activity === "typing") {
          document.querySelector(
            "#status"
          ).innerHTML = `${chatItem.activity} <span class="typewriterDot">.</span><span class="typewriterDot">.</span><span class="typewriterDot">.</span>`;
          document.querySelector("#status").classList.add("typing");
        } else {
          document.querySelector("#status").innerHTML = `${
            chatItem.members ? chatItem.members : ""
          }${chatItem.activity}`;
          document.querySelector("#status").classList.remove("typing");
        }
        // re-render new messages after cleaning older ones
        document.querySelector(".main-chat .container").innerHTML = "";
        chatItem.messages.forEach((message) => {
          document.querySelector(".main-chat .container").innerHTML += `
                    <div style="display: flex; ${
                      message.is_from_me ? "justify-content: flex-end;" : ""
                    }">
                    <div id="${message.id}" class="message ${
            message.is_from_me ? "from-me" : "to-me"
          } ${
            message.is_service_notifications
              ? "service_notification"
              : "has-tail"
          } ">
                        ${message.text}
                        <div class="message_time">${new Date(
                          message.time
                        ).getHours()}:${new Date(message.time).getMinutes()} ${
            message.is_from_me
              ? '<i class="fa fa-check" aria-hidden="true"></i>'
              : ""
          }</div>
                        <div class="tail"></div>
                    </div>
                    </div>`;
        });
      }
    });
  }

  // render right column in case it's expanded:
  if (document.querySelector("#column-right").classList.contains("expanded")) {
    fill_right_column();
  }

  // go to the last or target message (middle column uchun)
  location.href = `#${message_to_show}`;

  // render emojis
  let active_emoji_category = Number(
    document.querySelector(".emoji_nav .active").getAttribute("data-target")
  );
  // render emoji-sticker-or-gif///////////////kop vaqt olyapti
  document.querySelector("#emoji_here").innerHTML = "";
  EMOJI_PACK.forEach((category, index) => {
    if (index === active_emoji_category) {
      category.forEach((emoji) => {
        document.querySelector(
          "#emoji_here"
        ).innerHTML += `<button class="emoji-item">${emoji}</button>`;
      });
    }
  });
  set_emo_event();
}

// when input new message, button alsa changes
let multi_key_logger = {}; //keeps track of 2 keypress
document
  .querySelector(".new-message-text #input")
  .addEventListener("keydown", (e) => {
    multi_key_logger[e.keyCode] = true; //when key is pressed, return true
  });
document
  .querySelector(".new-message-text #input")
  .addEventListener("keyup", (e) => {
    if (multi_key_logger[13] && !multi_key_logger[16]) {
      //if ENTER is pressed not in combination with SHIFT, send message
      if (e.target.value && e.target.value.trim()) {
        //if input isn't empty
        set_new_message(); // NEW MESSAGE CODES HERE
      } else {
        document.querySelector(".new-message-text #input").value = "";
      }
    }
    multi_key_logger[e.keyCode] = false; //when key is released, return false

    if (e.target.value && e.target.value.trim()) {
      //if input isn't empty
      document
        .querySelector(".new-message-voice i")
        .classList.remove("fa-microphone");
      document
        .querySelector(".new-message-voice i")
        .classList.add("fa-paper-plane");
      e.target.style.height = e.target.scrollHeight + "px";
      console.log(e.target.scrollHeight);
    } else {
      //if input is empty
      document
        .querySelector(".new-message-voice i")
        .classList.add("fa-microphone");
      document
        .querySelector(".new-message-voice i")
        .classList.remove("fa-paper-plane");
    }
    document.querySelector("#emoji_dropdown").classList.remove("active");
  });

// NEW MESSAGE CODES HERE
function set_new_message() {
  let new_message = document.querySelector(".new-message-text #input").value;
  let DATA_from_local_storage = JSON.parse(localStorage.getItem("DATA"));
  Object.keys(DATA_from_local_storage).forEach((tab) => {
    DATA_from_local_storage[tab].forEach((individ) => {
      if (individ.user_name === selected_chat_username) {
        // writes new message to local var
        individ.messages.push({
          id: Number(individ.messages[individ.messages.length - 1].id) + 1,
          is_from_me: true,
          text: new_message,
          time: new Date().getTime(),
        });
        // sets new message to localStorage
        localStorage.setItem("DATA", JSON.stringify(DATA_from_local_storage));

        // re-render middle column with new messages
        let last_message = individ.messages[individ.messages.length - 1]; //clean code uchun ohirgi message ni qisqa nomlash
        last_message.text = last_message.text.replace(
          new RegExp("\n", "g"),
          "<br>"
        );
        document.querySelector(".main-chat .container").innerHTML += `
        <div style="display: flex; ${
          last_message.is_from_me ? "justify-content: flex-end;" : ""
        }">
            <div id="${last_message.id}" class="message ${
          last_message.is_from_me ? "from-me" : "to-me"
        } has-tail">
                ${last_message.text}
                <div class="message_time">${new Date(
                  last_message.time
                ).getHours()}:${new Date(last_message.time).getMinutes()} ${
          last_message.is_from_me
            ? '<i class="fa fa-check" aria-hidden="true"></i>'
            : ""
        }</div>
                <div class="tail"></div>
            </div>
        </div>`;
        // go to last or selected message
        location.href = `#${last_message.id}`;
        // input ni tozalab qoyadi
        document.querySelector(".new-message-text #input").value = "";
        // send btn ham ishlamaydi, chunki input pustoy
        document
          .querySelector(".new-message-voice i")
          .classList.add("fa-microphone");
        document
          .querySelector(".new-message-voice i")
          .classList.remove("fa-paper-plane");
        document.querySelector(".new-message-text #input").focus();
        // LEFT column a re-render bo'lyapti. Yangilab qoysin chatlarni
        fill_left_column(selected_chatlist);
      }
    });
  });
  // close emoji modal if present
  document.querySelector("#emoji_dropdown").classList.remove("active");
  document.querySelector("#input").style.height = "18.4px";
  console.log("height");
}

// send button only works when input isn't empty + VOICE input
document.querySelector(".new-message-voice").addEventListener("click", (e) => {
  if (e.target.firstElementChild.classList.contains("fa-paper-plane")) {
    // if no chat selected : //bunaqa bomidi-yu, mayli turaversin
    if (!selected_chat_username) {
      document.querySelector(".new-message-text #input").value = ``;
      document.querySelector(
        ".new-message-text #input"
      ).placeholder = `Avval birorta chatni tanlang, Janob ${ism && ism}`;
    }
    // if a chat is selected
    else {
      set_new_message(); // NEW MESSAGE CODES HERE
    }
  } else if (e.target.firstElementChild.classList.contains("fa-microphone")) {
    //voice input

    let recognition = new webkitSpeechRecognition();
    recognition.lang = "uz-Latn"; //"en-GB"; //uz-Cyrl  //en-US
    recognition.onresult = function (e) {
      document.querySelector(".new-message-text #input").value +=
        e.results[0][0].transcript;
      // set focus and some styling
      document.querySelector(".new-message-voice").classList.remove("active");
      document.querySelector("#input").focus();
    };

    if (!e.target.classList.contains("active")) {
      //if voice input isn't acivated
      e.target.classList.add("active");
      recognition.start();
    } else {
      //if voice input is active and user wants to stop voice input
      e.target.classList.remove("active");
      recognition.stop();
      // console.log('Speech recognition has stopped.');
    }
  }
});

// toggle right column window + search + more btn
document.querySelector(".person").addEventListener("click", (e) => {
  // if any chat is Selected
  if (
    !(
      document.querySelector("#name").textContent ===
      "Select a chat to start messaging"
    )
  ) {
    // if search btn is clicked
    if (e.target.classList.contains("search-btn")) {
      document.querySelector("#search").focus();
      is_searching_messages = true;
    } else if (e.target.classList.contains("more-btn")) {
      //if more btn is clicked

      document.querySelector("#control_menu_2").focus(); //set focus to menuList
      let DATA_from_local_storage = JSON.parse(localStorage.getItem("DATA"));

      Object.keys(DATA_from_local_storage).forEach((tab) => {
        DATA_from_local_storage[tab].forEach((individ) => {
          if (individ.user_name === selected_chat_username) {
            // more btn uchun menyular chat ga qarab o'zgaradi
            if (tab === "people") {
              document.querySelector("#control_menu_2").innerHTML = `
                            <li class="more_btn_event_handler"><i class="fa fa-pencil" aria-hidden="true"></i> Edit contact</li>
                            <li class="more_btn_event_handler"><i class="fa fa-trash" aria-hidden="true"></i> Delete contact</li>
                            <li class="more_btn_event_handler"><i class="fa fa-history" aria-hidden="true"></i> Clear history</li>
                            <li class="more_btn_event_handler red"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> Delete chat</li>
                            <li class="more_btn_event_handler"><i class="fa fa-lock" aria-hidden="true"></i> Block user</li>`;
            } else if (tab === "groups") {
              document.querySelector("#control_menu_2").innerHTML = `
                            <li class="more_btn_event_handler"><i class="fa fa-users" aria-hidden="true"></i> Manage group</li>
                            <li class="more_btn_event_handler"><i class="fa fa-history" aria-hidden="true"></i> Clear history</li>
                            <li class="more_btn_event_handler red"><i class="fa fa-sign-out" aria-hidden="true"></i> Leave group</li>
                            <li class="more_btn_event_handler"><i class="fa fa-flag" aria-hidden="true"></i> Report</li>`;
            } else if (tab === "channels") {
              document.querySelector("#control_menu_2").innerHTML = `
                            <li class="more_btn_event_handler"><i class="fa fa-users" aria-hidden="true"></i> Manage channel</li>
                            <li class="more_btn_event_handler"><i class="fa fa-history" aria-hidden="true"></i> Clear history</li>
                            <li class="more_btn_event_handler red"><i class="fa fa-sign-out" aria-hidden="true"></i> Leave channel</li>
                            <li class="more_btn_event_handler"><i class="fa fa-flag" aria-hidden="true"></i> Report</li>`;
            } else if (tab === "bots") {
              document.querySelector("#control_menu_2").innerHTML = `
                            <li class="more_btn_event_handler"><i class="fa fa-history" aria-hidden="true"></i> Clear history</li>
                            <li class="more_btn_event_handler"><i class="fa fa-lock" aria-hidden="true"></i> Block user</li>
                            <li class="more_btn_event_handler red"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> Delete chat</li>
                            <li class="more_btn_event_handler"><i class="fa fa-flag" aria-hidden="true"></i> Report</li>`;
            }
          }
        });
      });

      document.querySelector(".more-btn-content").classList.toggle("active");
    } else if (e.target.classList.contains("more_btn_event_handler")) {
      //more btn contents menu xullas aji buji :)
      if (e.target.firstElementChild.classList.contains("fa-pencil")) {
        edit_contact_modal();
        document.querySelector(".more-btn-content").classList.remove("active");
      } else if (e.target.firstElementChild.classList.contains("fa-trash")) {
        delete_contact_modal();
        document.querySelector(".more-btn-content").classList.remove("active");
      } else if (e.target.firstElementChild.classList.contains("fa-history")) {
        clear_history_modal();
        document.querySelector(".more-btn-content").classList.remove("active");
      } else if (
        e.target.firstElementChild.classList.contains("fa-exclamation-triangle")
      ) {
        delete_chat_modal();
        document.querySelector(".more-btn-content").classList.remove("active");
      } else if (e.target.firstElementChild.classList.contains("fa-lock")) {
        block_user_modal();
        document.querySelector(".more-btn-content").classList.remove("active");
      } else if (e.target.firstElementChild.classList.contains("fa-users")) {
        manage_group_modal();
        document.querySelector(".more-btn-content").classList.remove("active");
      } else if (e.target.firstElementChild.classList.contains("fa-sign-out")) {
        leave_group_modal();
        document.querySelector(".more-btn-content").classList.remove("active");
      } else if (e.target.firstElementChild.classList.contains("fa-flag")) {
        report_modal();
        document.querySelector(".more-btn-content").classList.remove("active");
      }
    } else {
      if (
        !document.querySelector("#column-center").classList.contains("shrinked")
      ) {
        document.querySelector("#telegram").style.gridTemplateColumns =
          "27.5% 1fr 25%";
      }

      document.querySelector("#column-center").classList.add("shrinked");
      document.querySelector("#column-right").classList.add("expanded");

      fill_right_column();
    }
  }
});

// if more-btn on blur, CLOSE F***ng more-btn-content
document.querySelector("#control_menu_2").addEventListener("blur", () => {
  document.querySelector(".more-btn-content").classList.remove("active");
});
// ********MODALS*********
function edit_contact_modal() {
  document.querySelector(".edit_contact_modal").classList.toggle("active");

  let DATA_from_local_storage = JSON.parse(localStorage.getItem("DATA"));
  // render data
  Object.keys(DATA_from_local_storage).forEach((tab) => {
    DATA_from_local_storage[tab].forEach((individ) => {
      if (individ.user_name === selected_chat_username) {
        document.querySelector(".modal_avatar").src = ` ${
          individ.avatar[0]
            ? individ.avatar[0]
            : "https://picsum.photos/id/115/400/384"
        } `;
        document.querySelector(
          "#edit_tel"
        ).innerHTML = ` ${individ.phone_number} `;
        document.querySelector(
          "#edit_status"
        ).innerHTML = `${individ.activity} `;
        document.querySelector("#edit_first_name").value = `${
          individ.first_name ? individ.first_name : individ.name
        } `;
        document.querySelector("#edit_last_name").value = `${
          individ.last_name ? individ.last_name : ""
        } `;
      }
    });
  });
}
//delete contact modal button
function delete_contact_modal() {
  document.querySelector(".delete_contact_modal").classList.toggle("active");
  let DATA_from_local_storage = JSON.parse(localStorage.getItem("DATA"));
  // render data
  Object.keys(DATA_from_local_storage).forEach((tab) => {
    DATA_from_local_storage[tab].forEach((individ) => {
      if (individ.user_name === selected_chat_username) {
        document.querySelector(".delete_contact_avatar").src = ` ${
          individ.avatar[0]
            ? individ.avatar[0]
            : "https://picsum.photos/id/115/400/384"
        } `;
        document.querySelector("#delete_contact_name").innerHTML = `${
          individ.first_name ? individ.first_name : individ.name
        } ${individ.last_name && individ.last_name}`;
      }
    });
  });
}
//clear history modal button
function clear_history_modal() {
  document.querySelector(".clear_history_modal").classList.toggle("active");
  let DATA_from_local_storage = JSON.parse(localStorage.getItem("DATA"));
  // render data
  Object.keys(DATA_from_local_storage).forEach((tab) => {
    DATA_from_local_storage[tab].forEach((individ) => {
      if (individ.user_name === selected_chat_username) {
        document.querySelector(".clear_history_avatar").src = ` ${
          individ.avatar[0]
            ? individ.avatar[0]
            : "https://picsum.photos/id/115/400/384"
        } `;
        document.querySelector("#clear_history_name").innerHTML = `${
          individ.first_name ? individ.first_name : individ.name
        } ${individ.last_name && individ.last_name}`;
      }
    });
  });
}
//delete chat modal button
function delete_chat_modal() {
  document.querySelector(".delete_chat_modal").classList.toggle("active");
  let DATA_from_local_storage = JSON.parse(localStorage.getItem("DATA"));
  // render data
  Object.keys(DATA_from_local_storage).forEach((tab) => {
    DATA_from_local_storage[tab].forEach((individ) => {
      if (individ.user_name === selected_chat_username) {
        document.querySelector(".delete_chat_avatar").src = ` ${
          individ.avatar[0]
            ? individ.avatar[0]
            : "https://picsum.photos/id/115/400/384"
        } `;
        document.querySelectorAll(".delete_chat_name").forEach((name) => {
          name.innerHTML = `${
            individ.first_name ? individ.first_name : individ.name
          } ${individ.last_name ? individ.last_name : ""}`;
        });
      }
    });
  });
}
//block user modal button
function block_user_modal() {
  document.querySelector(".block_user_modal").classList.toggle("active");
  let DATA_from_local_storage = JSON.parse(localStorage.getItem("DATA"));
  // render data
  Object.keys(DATA_from_local_storage).forEach((tab) => {
    DATA_from_local_storage[tab].forEach((individ) => {
      if (individ.user_name === selected_chat_username) {
        document.querySelector(".block_user_avatar").src = ` ${
          individ.avatar[0]
            ? individ.avatar[0]
            : "https://picsum.photos/id/115/400/384"
        } `;
        document.querySelectorAll(".block_user_name").forEach((name) => {
          name.innerHTML = `${
            individ.first_name ? individ.first_name : individ.name
          } ${individ.last_name && individ.last_name}`;
        });
      }
    });
  });
}
// manage group
function manage_group_modal() {
  document.querySelector(".manage_group_modal").classList.toggle("active");

  let DATA_from_local_storage = JSON.parse(localStorage.getItem("DATA"));
  // render data
  Object.keys(DATA_from_local_storage).forEach((tab) => {
    DATA_from_local_storage[tab].forEach((individ) => {
      if (individ.user_name === selected_chat_username) {
        document.querySelector(".manage_group_header").innerHTML =
          tab === "groups"
            ? "Edit group"
            : tab === "channels"
            ? "Edit channel"
            : "Edit bot";
        document.querySelectorAll(".modal_avatar").forEach((img) => {
          img.src = ` ${
            individ.avatar[0]
              ? individ.avatar[0]
              : "https://picsum.photos/id/115/400/384"
          } `;
        });
        document.querySelector("#edit_group_name").value = `${
          individ.name ? individ.name : ""
        } `;
        document.querySelector("#edit_group_bio").value = `${
          individ.bio ? individ.bio : ""
        } `;
      }
    });
  });
}
// leave group
function leave_group_modal() {
  document.querySelector(".leave_group_modal").classList.toggle("active");
  let DATA_from_local_storage = JSON.parse(localStorage.getItem("DATA"));
  // render data
  Object.keys(DATA_from_local_storage).forEach((tab) => {
    DATA_from_local_storage[tab].forEach((individ) => {
      if (individ.user_name === selected_chat_username) {
        document.querySelector(".leave_group_avatar").src = ` ${
          individ.avatar[0]
            ? individ.avatar[0]
            : "https://picsum.photos/id/115/400/384"
        } `;
        document.querySelectorAll(".leave_group_name").forEach((name) => {
          name.innerHTML = `${
            individ.first_name ? individ.first_name : individ.name
          } ${individ.last_name ? individ.last_name : ""}`;
        });
      }
    });
  });
}
// report
function report_modal() {
  document.querySelector(".report_modal").classList.toggle("active");
  let DATA_from_local_storage = JSON.parse(localStorage.getItem("DATA"));
  // render data
  Object.keys(DATA_from_local_storage).forEach((tab) => {
    DATA_from_local_storage[tab].forEach((individ) => {
      if (individ.user_name === selected_chat_username) {
        document.querySelector(".report_avatar").src = ` ${
          individ.avatar[0]
            ? individ.avatar[0]
            : "https://picsum.photos/id/115/400/384"
        } `;
        document.querySelector(".report_name").innerHTML = `${
          individ.first_name ? individ.first_name : individ.name
        } ${individ.last_name ? individ.last_name : ""}`;
      }
    });
  });
}

document.querySelectorAll(".contact_modal").forEach((modal) => {
  modal.addEventListener("click", (e) => {
    //close modal on click to outer area
    if (
      e.target.classList.contains("contact_modal") |
      e.target.classList.contains("edit_contact_cancel") |
      e.target.classList.contains("delete_contact_cancel") |
      e.target.classList.contains("clear_history_cancel") |
      e.target.classList.contains("delete_chat_cancel") |
      e.target.classList.contains("manage_group_cancel") |
      e.target.classList.contains("block_user_cancel") |
      e.target.classList.contains("leave_group_cancel") |
      e.target.classList.contains("report_cancel") |
      e.target.classList.contains("new_group_cancel") |
      e.target.classList.contains("new_channel_cancel")
    ) {
      document.querySelectorAll(".contact_modal").forEach((modal_to_close) => {
        modal_to_close.classList.remove("active");
      });
    } else if (e.target.classList.contains("edit_contact_done")) {
      //when edit is done

      let firstName = document.querySelector("#edit_first_name").value;
      let lastName = document.querySelector("#edit_last_name").value;

      let DATA_from_local_storage = JSON.parse(localStorage.getItem("DATA"));
      // refresh data with new changes
      Object.keys(DATA_from_local_storage).forEach((tab) => {
        DATA_from_local_storage[tab].forEach((individ) => {
          if (individ.user_name === selected_chat_username) {
            if (individ.name) {
              individ.name = `${firstName ? firstName : ""} ${
                lastName ? lastName : ""
              }`;
            } else {
              individ.first_name = firstName;
              individ.last_name = lastName;
            }
          }
        });
      });
      localStorage.setItem("DATA", JSON.stringify(DATA_from_local_storage)); //sets to local storage
      document.querySelector(".edit_contact_modal").classList.toggle("active"); //closes modal
      //renders new data
      re_render();
    } else if (e.target.classList.contains("delete_contact_done")) {
      //when delete contact is done
      let DATA_from_local_storage = JSON.parse(localStorage.getItem("DATA"));
      // refresh data with new changes
      Object.keys(DATA_from_local_storage).forEach((tab) => {
        DATA_from_local_storage[tab].forEach((individ) => {
          if (individ.user_name === selected_chat_username) {
            if (individ.name) {
              individ.name = `Unknown Organisation`;
            } else {
              individ.first_name = "Unknown";
              individ.last_name = "User";
            }
          }
        });
      });
      localStorage.setItem("DATA", JSON.stringify(DATA_from_local_storage)); //sets to local storage
      document
        .querySelector(".delete_contact_modal")
        .classList.remove("active"); //closes modal
      //renders new data
      re_render();
    } else if (e.target.classList.contains("clear_history_done")) {
      //when history is cleared
      let DATA_from_local_storage = JSON.parse(localStorage.getItem("DATA"));
      // refresh data with new changes
      Object.keys(DATA_from_local_storage).forEach((tab) => {
        DATA_from_local_storage[tab].forEach((individ) => {
          if (individ.user_name === selected_chat_username) {
            individ.shared_files = individ.shared_files && 0;
            individ.shared_links = individ.shared_links && 0;
            individ.shared_photos = individ.shared_photos && 0;
            individ.shared_voice = individ.shared_voice && 0;
            individ.shared_videos = individ.shared_videos && 0;
            individ.messages = [
              {
                id: 1,
                is_from_me: false,
                is_service_notifications: true,
                text: "History was cleared :(",
                time: new Date().getTime(),
              },
            ];
          }
        });
      });
      localStorage.setItem("DATA", JSON.stringify(DATA_from_local_storage)); //sets to local storage
      document.querySelector(".clear_history_modal").classList.remove("active"); //closes modal
      //renders new data
      re_render();
    } else if (e.target.classList.contains("delete_chat_done")) {
      //when chat is deleted
      let DATA_from_local_storage = JSON.parse(localStorage.getItem("DATA"));
      // refresh data with new changes
      Object.keys(DATA_from_local_storage).forEach((tab) => {
        DATA_from_local_storage[tab].forEach((individ) => {
          if (individ.user_name === selected_chat_username) {
            individ.shared_files = individ.shared_files && 0;
            individ.shared_links = individ.shared_links && 0;
            individ.shared_photos = individ.shared_photos && 0;
            individ.shared_voice = individ.shared_voice && 0;
            individ.shared_videos = individ.shared_videos && 0;
            individ.messages = [];
          }
        });
      });
      localStorage.setItem("DATA", JSON.stringify(DATA_from_local_storage)); //sets to local storage
      document.querySelector(".delete_chat_modal").classList.remove("active"); //closes modal
      //renders new data

      // TO LEFT COLUMN
      selected_chatlist = document
        .querySelector(".navbar li.active")
        .getAttribute("data-target");
      fill_left_column(selected_chatlist);
      // TO MIDDLE COLUMN
      document.querySelector(".main-chat .container").innerHTML = `
            <div style="display: flex; ">
                    <div id="1" class="message to-me service_notification ">
                        You deleted this chat
                        <div class="message_time">${new Date().getHours()}:${new Date().getMinutes()} </div>
                        <div class="tail"></div>
                    </div>
            </div>
            `;
      document.querySelector(
        "#avatar"
      ).src = `${DATA_from_local_storage.me[1].avatar}`;
      document.querySelector("#name").innerHTML =
        "Select a chat to start messaging";
      document.querySelector("#status").innerHTML = "";

      // TO RIGHT COLUMN
      document.querySelector("#telegram").style.gridTemplateColumns =
        "27.5% 1fr 0%";
      document.querySelector("#column-center").classList.remove("shrinked");
      document.querySelector("#column-right").classList.remove("expanded");
    } else if (e.target.classList.contains("block_user_done")) {
      //when user blockedd
      let DATA_from_local_storage = JSON.parse(localStorage.getItem("DATA"));
      // refresh data with new changes
      Object.keys(DATA_from_local_storage).forEach((tab) => {
        DATA_from_local_storage[tab].forEach((individ) => {
          if (individ.user_name === selected_chat_username) {
            individ.messages.push({
              id: `${individ.messages[individ.messages.length - 1].id + 1}`,
              is_from_me: false,
              is_service_notifications: true,
              text: `You blocked ${individ.user_name}. He/she no longer bothers you :)`,
              time: new Date().getTime(),
            });
          }
        });
      });
      localStorage.setItem("DATA", JSON.stringify(DATA_from_local_storage)); //sets to local storage
      document.querySelector(".block_user_modal").classList.remove("active"); //closes modal
      //renders new data
      re_render();
    } else if (e.target.classList.contains("manage_group_done")) {
      //when group is edited

      let name = document.querySelector("#edit_group_name").value;
      let bio = document.querySelector("#edit_group_bio").value;

      let DATA_from_local_storage = JSON.parse(localStorage.getItem("DATA"));
      // refresh data with new changes
      Object.keys(DATA_from_local_storage).forEach((tab) => {
        DATA_from_local_storage[tab].forEach((individ) => {
          if (individ.user_name === selected_chat_username) {
            individ.name = `${name ? name : ""}`;
            individ.bio = `${bio ? bio : ""}`;
          }
        });
      });
      localStorage.setItem("DATA", JSON.stringify(DATA_from_local_storage)); //sets to local storage
      document.querySelector(".manage_group_modal").classList.remove("active"); //closes modal
      //renders new data
      re_render();
    } else if (e.target.classList.contains("leave_group_done")) {
      //when you leave group

      let DATA_from_local_storage = JSON.parse(localStorage.getItem("DATA"));
      // remove group from DATA
      Object.keys(DATA_from_local_storage).forEach((tab) => {
        DATA_from_local_storage[tab].forEach((individ, index) => {
          if (individ.user_name === selected_chat_username) {
            DATA_from_local_storage[tab].splice(index, 1);
          }
        });
      });
      localStorage.setItem("DATA", JSON.stringify(DATA_from_local_storage)); //sets to local storage
      document.querySelector(".leave_group_modal").classList.remove("active"); //closes modal
      //renders new data

      // TO LEFT COLUMN
      fill_left_column(
        document.querySelector(".navbar li.active").getAttribute("data-target")
      );
      // TO MIDDLE COLUMN
      document.querySelector(".main-chat .container").innerHTML = `
            <div style="display: flex; ">
                    <div id="1" class="message to-me service_notification ">
                        You left this group
                        <div class="message_time">${new Date().getHours()}:${new Date().getMinutes()} </div>
                        <div class="tail"></div>
                    </div>
            </div>
            `;
      document.querySelector(
        "#avatar"
      ).src = `${DATA_from_local_storage.me[1].avatar}`;
      document.querySelector("#name").innerHTML =
        "Select a chat to start messaging";
      document.querySelector("#status").innerHTML = "";

      // TO RIGHT COLUMN
      document.querySelector("#telegram").style.gridTemplateColumns =
        "27.5% 1fr 0%";
      document.querySelector("#column-center").classList.remove("shrinked");
      document.querySelector("#column-right").classList.remove("expanded");
    } else if (e.target.classList.contains("report_done")) {
      //when you leave group

      let DATA_from_local_storage = JSON.parse(localStorage.getItem("DATA"));
      // remove group from DATA
      Object.keys(DATA_from_local_storage).forEach((tab) => {
        DATA_from_local_storage[tab].forEach((individ) => {
          if (individ.user_name === selected_chat_username) {
            individ.report = [e.target.value];
            individ.messages.push({
              id: `${individ.messages[individ.messages.length - 1].id + 1}`,
              is_from_me: false,
              is_service_notifications: true,
              text: `Successfully reported !`,
              time: new Date().getTime(),
            });
          }
        });
      });
      localStorage.setItem("DATA", JSON.stringify(DATA_from_local_storage)); //sets to local storage
      document.querySelector(".report_modal").classList.remove("active"); //closes modal
      //renders new data
      re_render();
    } else if (e.target.classList.contains("new_group_done")) {
      //for creating a new group

      let DATA_from_local_storage = JSON.parse(localStorage.getItem("DATA"));
      let name = document.querySelector("#new_group_name").value;
      let username = document.querySelector("#new_group_link").value;
      let bio = document.querySelector("#new_group_bio").value;
      let avatar = document.querySelector("#new_group_avatar").src;

      DATA_from_local_storage.groups.push({
        id: 1,
        name: name,
        avatar: [avatar],
        bio: bio,
        user_name: username,
        members: 1,
        shared_links: 0,
        shared_files: 0,
        shared_photos: 0,
        shared_voice: 0,
        shared_videos: 0,
        activity: " members, 1 online",
        messages: [
          {
            id: 1,
            is_from_me: false,
            is_service_notifications: true,
            text: `new group '${name}' has been created`,
            time: new Date().getTime(),
          },
        ],
      });
      localStorage.setItem("DATA", JSON.stringify(DATA_from_local_storage)); //sets to local storage
      document.querySelector(".new_group_modal").classList.remove("active"); //closes modal

      // TO LEFT COLUMN
      document.querySelectorAll(".navbar li").forEach((elem) => {
        elem.classList.remove("active");
      });
      document.querySelector(`[data-target="groups"]`).classList.add("active");
      document.querySelectorAll(".tabs-content").forEach((elem) => {
        elem.classList.remove("active");
        elem.innerHTML = ""; // qolgan tab larni ichini tozalaydi
      });
      document.querySelector(`#groups`).classList.add("active");
      fill_left_column("groups");

      // TO MIDDLE COLUMN
      fill_middle_column(document.querySelector("#groups").lastElementChild);
      // TO RIGHT COLUMN
      fill_right_column();
    } else if (e.target.classList.contains("new_channel_done")) {
      //for creating a new channel

      let DATA_from_local_storage = JSON.parse(localStorage.getItem("DATA"));
      let name = document.querySelector("#new_channel_name").value;
      let username = document.querySelector("#new_channel_link").value;
      let bio = document.querySelector("#new_channel_bio").value;
      let avatar = document.querySelector("#new_channel_avatar").src;

      DATA_from_local_storage.channels.push({
        id: 1,
        name: name,
        avatar: [avatar],
        bio: bio,
        user_name: username,
        members: 1,
        shared_links: 0,
        shared_files: 0,
        shared_photos: 0,
        shared_voice: 0,
        shared_videos: 0,
        activity: " members, 1 online",
        messages: [
          {
            id: 1,
            is_from_me: false,
            is_service_notifications: true,
            text: `new channel '${name}' has been created`,
            time: new Date().getTime(),
          },
        ],
      });
      localStorage.setItem("DATA", JSON.stringify(DATA_from_local_storage)); //sets to local storage
      document.querySelector(".new_channel_modal").classList.remove("active"); //closes modal

      // TO LEFT COLUMN
      document.querySelectorAll(".navbar li").forEach((elem) => {
        elem.classList.remove("active");
      });
      document
        .querySelector(`[data-target="channels"]`)
        .classList.add("active");
      document.querySelectorAll(".tabs-content").forEach((elem) => {
        elem.classList.remove("active");
        elem.innerHTML = ""; // qolgan tab larni ichini tozalaydi
      });
      document.querySelector(`#channels`).classList.add("active");
      fill_left_column("channels");

      // TO MIDDLE COLUMN
      fill_middle_column(document.querySelector("#channels").lastElementChild);
      // TO RIGHT COLUMN
      fill_right_column();
    }
  });
});

////////////////////////////////////////////RIGHT COLUMN//////////////////////////////////////////////////////////

// renders DATA to right column
function fill_right_column() {
  let DATA_from_local_storage = JSON.parse(localStorage.getItem("DATA"));

  // clear carousel images AND TABS before rendering
  document.querySelector(".carousel-items").innerHTML = "";
  document.querySelector(".carousel-items-tabs").innerHTML = "";

  // render data
  Object.keys(DATA_from_local_storage).forEach((tab) => {
    DATA_from_local_storage[tab].forEach((individ) => {
      if (individ.user_name === selected_chat_username) {
        // header edit btn
        document
          .querySelector(".edit-btn")
          .addEventListener("click", edit_btn_bug_fixer);
        // carousel image rendering
        if (individ.avatar.length === 0) {
          //if there's no image
          // put rainy image on carousel
          document.querySelector(".carousel-items").innerHTML = `
                        <div class="carousel-item active">
                            <img class="carousel-item-image" src="https://picsum.photos/id/115/400/384">
                        </div>
                        `;
          // set one tab on carousel navbar
          document.querySelector(
            ".carousel-items-tabs"
          ).innerHTML = `<div class="carousel-items-tab active"></div>`;
        } else {
          //if there are images
          // render avatars
          individ.avatar.forEach((img, index) => {
            document.querySelector(".carousel-items").innerHTML += `
                            <div class="carousel-item ${
                              index === 0 ? "active" : ""
                            }">
                                <img class="carousel-item-image" src="${
                                  img ? img : "https://picsum.photos/500/384"
                                }">
                            </div>
                            `;

            // render nav  tabs as many as avatars
            document.querySelector(
              ".carousel-items-tabs"
            ).innerHTML += `<div class="carousel-items-tab ${
              index === 0 ? "active" : ""
            }"></div>`;
          });
        }
        // render name and status
        document.querySelector(
          ".carousel-items-info .profile-name"
        ).innerHTML = `${
          individ.first_name ? individ.first_name : individ.name
        } ${individ.last_name ? individ.last_name : ""}`;
        document.querySelector(
          ".carousel-items-info .profile-subtitle"
        ).innerHTML = `${individ.activity}`;

        // balo battar ma'lumomtlar bori namoyon bo'lur :)
        document.querySelector(".right-main").innerHTML = ""; //tozalavol
        // phone
        if (individ.hasOwnProperty("phone_number")) {
          document.querySelector(".right-main").innerHTML += `
                <div class="right-main-item">
                    <div class="r_icon"><i class="fa fa-phone" aria-hidden="true"></i></div>
                    <div class="r_text">
                        <div>${
                          individ.phone_number ? individ.phone_number : "hidden"
                        }</div>
                        <span>Phone</span>
                    </div>
                </div>`;
        }
        // username
        if (individ.user_name) {
          document.querySelector(".right-main").innerHTML += `
                <div class="right-main-item">
                    <div class="r_icon">@</div>
                    <div class="r_text">
                        <div>${individ.user_name}</div>
                        <span>Username</span>
                    </div>
                </div>`;
        }
        // bio
        if (individ.bio) {
          document.querySelector(".right-main").innerHTML += `
                <div class="right-main-item">
                    <div class="r_icon"><i class="fa fa-info-circle" aria-hidden="true"></i></div>
                    <div class="r_text">
                        <div>${individ.bio}</div>
                        <span>Bio</span>
                    </div>
                </div>`;
        }
        // notifications
        document.querySelector(".right-main").innerHTML += `
            <div class="right-main-item">
                <div class="r_icon"><i class="fa fa-bell-o" aria-hidden="true"></i></div>
                <div class="r_text bell-text">
                    <div>Notifications</div>
                    <button class="toggle-notification">
                        <i class="fa fa-toggle-on" aria-hidden="true"></i>
                    </button>
                </div>
            </div>`;
        // notification event listener  // toggle-notification
        document
          .querySelector(".toggle-notification")
          .addEventListener("click", () => {
            document
              .querySelector(".toggle-notification")
              .firstElementChild.classList.toggle("fa-toggle-on");
            document
              .querySelector(".toggle-notification")
              .firstElementChild.classList.toggle("fa-toggle-off");
          });
        // shared media
        let selected_medialist = document
          .querySelector(".shared-media .active")
          .getAttribute("data-target");
        document.querySelector(`#${selected_medialist}`).innerHTML = individ[
          selected_medialist
        ]
          ? `You have ${individ[selected_medialist]} ${selected_medialist}. But I can't show them at the moment üò¨`
          : "You don't have anything shared here. Start sharing ü§ó now :)";
      }
    });
  });
}
function edit_btn_bug_fixer() {
  let active_tab;
  let DATA_from_local_storage = JSON.parse(localStorage.getItem("DATA"));
  Object.keys(DATA_from_local_storage).forEach((tab) => {
    DATA_from_local_storage[tab].forEach((individ) => {
      if (individ.user_name === selected_chat_username) {
        active_tab = tab;
      }
    });
  });
  if (active_tab === "people") {
    edit_contact_modal();
  } else {
    manage_group_modal();
  }
}
// carousel next/prev buttons
let carousel_items = document.querySelector(".carousel-items");
document.querySelectorAll(".carousel-items-arrow").forEach((navbtn) => {
  navbtn.addEventListener("click", (e) => {
    if (e.target.classList.contains("arrow-next")) {
      // next avatar
      for (let i = 0; i < carousel_items.children.length; i++) {
        if (carousel_items.children[i].classList.contains("active")) {
          // remove active class on avatar and nav tab :
          carousel_items.children[i].classList.remove("active");
          document
            .querySelector(".carousel-items-tabs")
            .children[i].classList.remove("active");

          if (i === carousel_items.children.length - 1) {
            //if it's the last pic:
            carousel_items.children[0].classList.add("active"); //show first pic
            document
              .querySelector(".carousel-items-tabs")
              .children[0].classList.add("active"); //shine first tab
          } else {
            carousel_items.children[i + 1].classList.add("active");
            document
              .querySelector(".carousel-items-tabs")
              .children[i + 1].classList.add("active");
          }
          break;
        }
      }
    } else if (e.target.classList.contains("arrow-prev")) {
      // prev avatar
      for (let i = 0; i < carousel_items.children.length; i++) {
        if (carousel_items.children[i].classList.contains("active")) {
          carousel_items.children[i].classList.remove("active");
          document
            .querySelector(".carousel-items-tabs")
            .children[i].classList.remove("active");

          if (i === 0) {
            //if it's the first pic:
            carousel_items.children[
              carousel_items.children.length - 1
            ].classList.add("active"); //show last pic
            document
              .querySelector(".carousel-items-tabs")
              .children[carousel_items.children.length - 1].classList.add(
                "active"
              ); //shine last tab
          } else {
            carousel_items.children[i - 1].classList.add("active");
            document
              .querySelector(".carousel-items-tabs")
              .children[i - 1].classList.add("active");
          }
          break;
        }
      }
    }
  });
});

// chat-tabs navigation match
document.querySelectorAll(".shared-media li").forEach((elem) => {
  elem.addEventListener("click", (e) => {
    let selected_medialist = e.target.getAttribute("data-target");
    // toggle .active on tabs
    document.querySelectorAll(".shared-media li").forEach((elem) => {
      elem.classList.remove("active");
    });
    e.target.classList.add("active");

    // corresponding tabs will be shown
    document.querySelectorAll(".shared_media_content").forEach((elem) => {
      elem.classList.remove("active");
      elem.innerHTML = ""; // qolgan tab larni ichini tozalaydi
    });
    document.querySelector(`#${selected_medialist}`).classList.add("active");
    // tanlangan chat ni ichini kontent bilan to'ldiradi
    let DATA_from_local_storage = JSON.parse(localStorage.getItem("DATA"));
    Object.keys(DATA_from_local_storage).forEach((tab) => {
      DATA_from_local_storage[tab].forEach((individ) => {
        if (individ.user_name === selected_chat_username) {
          document.querySelector(`#${selected_medialist}`).innerHTML = individ[
            selected_medialist
          ]
            ? `You have ${individ[selected_medialist]} ${selected_medialist}. But I can't show them at the moment üò¨`
            : "You don't have anything shared here. Start sharing ü§ó now :)";
        }
      });
    });
  });
});

// close right column btn
document.querySelector(".close-btn").addEventListener("click", (e) => {
  document.querySelector("#telegram").style.gridTemplateColumns =
    "27.5% 1fr 0%";
  document.querySelector("#column-center").classList.toggle("shrinked");
  document.querySelector("#column-right").classList.toggle("expanded");
});

//renders new data
function re_render() {
  // TO LEFT COLUMN
  selected_chatlist = document
    .querySelector(".navbar li.active")
    .getAttribute("data-target");
  fill_left_column(selected_chatlist);
  // TO MIDDLE COLUMN
  document.querySelectorAll(".chat_item").forEach((what) => {
    if (what.getAttribute("data-username") === `${selected_chat_username}`) {
      fill_middle_column(what);
    }
  });
  // TO RIGHT COLUMN
  fill_right_column();
}

// //////////////////////////////////EMOJI UCHUN/////////////////////////////////////
// open&close emoji
document
  .querySelector(".emoji")
  .addEventListener("click", () =>
    document.querySelector("#emoji_dropdown").classList.toggle("active")
  );
// emoji-sticker-gif-tabs navigation match
document.querySelectorAll(".emoji-tabs button").forEach((elem) => {
  elem.addEventListener("click", (e) => {
    if (e.target.id === "backspace") {
      //if erase btn is clicked
      let input = document.querySelector(".new-message-text #input");
      if (input.value) {
        input.value = input.value.slice(0, input.value.length - 1);
      }
    } else {
      let selected_medialist = e.target.getAttribute("data-target");

      // toggle .active on tabs
      document.querySelectorAll(".emoji-tabs button").forEach((elem) => {
        elem.classList.remove("active");
      });
      e.target.classList.add("active");

      // corresponding tabs will be shown
      document.querySelectorAll(".emoji-tab").forEach((elem) => {
        elem.classList.remove("active");
      });
      document.querySelector(`.${selected_medialist}`).classList.add("active");
    }
  });
});
// emoji itself navigate between categories
document.querySelectorAll(".emoji_nav button").forEach((button) => {
  button.addEventListener("click", (e) => {
    document.querySelector("#emoji_here").innerHTML = "";
    active_emoji_category = Number(e.target.getAttribute("data-target"));
    document.querySelectorAll(".emoji_nav button").forEach((button) => {
      //remove active from buttons
      button.classList.remove("active");
    });
    e.target.classList.add("active");

    EMOJI_PACK.forEach((category, index) => {
      if (index === active_emoji_category) {
        category.forEach((emoji) => {
          document.querySelector(
            "#emoji_here"
          ).innerHTML += `<button class="emoji-item">${emoji}</button>`;
        });
      }
    });
    set_emo_event();
  });
});
// connect to input when emo is clicked
function set_emo_event() {
  document.querySelectorAll("#emoji_here button").forEach((emo_button) => {
    emo_button.addEventListener("click", (e) => {
      document.querySelector(
        ".new-message-text #input"
      ).value += `${e.target.innerHTML}`;
      // activate input
      document.querySelector(".new-message-text #input").focus();
      document
        .querySelector(".new-message-voice i")
        .classList.remove("fa-microphone");
      document
        .querySelector(".new-message-voice i")
        .classList.add("fa-paper-plane");
    });
  });
}
// //////////////////////////////////KEYBOARD UCHUN/////////////////////////////////////
let is_shifted = false;
let is_caps_on = false;
let is_cyrillic = false;
document.querySelector(".keyboard").addEventListener("click", (e) => {
  document.querySelector("#keyboard_dropdown").classList.toggle("active");
  document.querySelector("#emoji_dropdown").classList.remove("active"); //close emoji if present
  if (
    document.querySelector("#keyboard_dropdown").classList.contains("active")
  ) {
    //render keys if keyboard active
    render_keys(is_shifted);
    document.querySelector(".new-message-text #input").focus();
  }
});

function render_keys(isShifted, isCyrillic) {
  // clear lines before rendering
  document.querySelectorAll(".line").forEach((line) => {
    line.innerHTML = "";
  });
  Object.keys(KEYBOARD_PACK).forEach((line) => {
    //render qilopti
    if (line === "first_line") {
      KEYBOARD_PACK[line].forEach((obj_key) => {
        if (obj_key.key === "Back") {
          document.querySelector(
            ".first-line"
          ).innerHTML += `<span class="back button-style">${obj_key.key}</span>`;
        } else {
          document.querySelector(
            ".first-line"
          ).innerHTML += `<span class="button button-style">${
            isShifted
              ? isCyrillic
                ? obj_key.cyrill_shift
                : obj_key.shift
              : isCyrillic
              ? obj_key.cyrill
              : obj_key.key
          }</span>`;
        }
      });
    } else if (line === "second_line") {
      KEYBOARD_PACK[line].forEach((obj_key) => {
        if (obj_key.key === "Tab") {
          document.querySelector(
            ".second-line"
          ).innerHTML += `<span class="tab button-style">${obj_key.key}</span>`;
        } else {
          document.querySelector(
            ".second-line"
          ).innerHTML += `<span class="button button-style">${
            isShifted
              ? isCyrillic
                ? obj_key.cyrill_shift
                : obj_key.shift
              : isCyrillic
              ? obj_key.cyrill
              : obj_key.key
          }</span>`;
        }
      });
    } else if (line === "third_line") {
      KEYBOARD_PACK[line].forEach((obj_key) => {
        if ((obj_key.key === "Caps") | (obj_key.key === "Enter")) {
          document.querySelector(".third-line").innerHTML += `<span class="${
            obj_key.key === "Caps" ? "capsLock" : "enter"
          } button-style">${obj_key.key}</span>`;
        } else {
          document.querySelector(
            ".third-line"
          ).innerHTML += `<span class="button button-style">${
            isShifted
              ? isCyrillic
                ? obj_key.cyrill_shift
                : obj_key.shift
              : isCyrillic
              ? obj_key.cyrill
              : obj_key.key
          }</span>`;
        }
      });
    } else if (line === "fourth_line") {
      KEYBOARD_PACK[line].forEach((obj_key) => {
        if (obj_key.key === "Shift") {
          document.querySelector(
            ".forth-line"
          ).innerHTML += `<span class="shift button-style">${obj_key.key}</span>`;
        } else {
          document.querySelector(
            ".forth-line"
          ).innerHTML += `<span class="button button-style">${
            isShifted
              ? isCyrillic
                ? obj_key.cyrill_shift
                : obj_key.shift
              : isCyrillic
              ? obj_key.cyrill
              : obj_key.key
          }</span>`;
        }
      });
    }
  });

  // check caps was on or not
  if (is_caps_on) {
    caps_function();
  }
  // sets event listeners to newly created buttonchalar :)

  // buttons for writing
  document.querySelectorAll(".button").forEach((btn) => {
    btn.addEventListener("click", (e) => {
      // shift sozlamasi
      if (isShifted) {
        is_shifted = false;
        render_keys(is_shifted, is_cyrillic);
      }
      document.querySelector(
        ".new-message-text #input"
      ).value += `${e.target.innerText}`;
      // activate input
      document.querySelector(".new-message-text #input").focus();
      document
        .querySelector(".new-message-voice i")
        .classList.remove("fa-microphone");
      document
        .querySelector(".new-message-voice i")
        .classList.add("fa-paper-plane");
    });
  });
  // caps lock
  document.querySelector(".capsLock").addEventListener("click", caps_function);
  // shift
  document.querySelectorAll(".shift").forEach((one_shift) => {
    one_shift.addEventListener("click", shift_func);
  });
  // esc
  document.querySelector(".esc").addEventListener("click", (e) => {
    document.querySelector("#keyboard_dropdown").classList.remove("active");
  });
  // back
  document.querySelector(".back").addEventListener("click", (e) => {
    document.querySelector(".new-message-text #input").value = document
      .querySelector(".new-message-text #input")
      .value.slice(
        0,
        document.querySelector(".new-message-text #input").value.length - 1
      );
    if (!document.querySelector(".new-message-text #input").value) {
      document
        .querySelector(".new-message-voice i")
        .classList.add("fa-microphone");
      document
        .querySelector(".new-message-voice i")
        .classList.remove("fa-paper-plane");
    }
    document.querySelector(".new-message-text #input").focus();
  });
  // tab
  document.querySelector(".tab").addEventListener("click", (e) => {
    document.querySelector(".new-message-text #input").value += "    ";
    document.querySelector(".new-message-text #input").focus();
  });
  // enter
  document.querySelector(".enter").addEventListener("click", (e) => {
    document.querySelector(".new-message-text #input").value += "\n";
    document.querySelector(".new-message-text #input").focus();
  });
  // lang
  document.querySelector(".language").addEventListener("click", lang_func);
  // left-right-arrows
  let caret_index = 0;
  document.querySelector(".left-arrow").addEventListener("click", (e) => {
    document.querySelector(".new-message-text #input").focus();
    let length = document.querySelector(".new-message-text #input").value
      .length;
    if (caret_index < length) {
      caret_index++; //bitta orqaga
    }
    document
      .querySelector(".new-message-text #input")
      .setSelectionRange(length - caret_index, length - caret_index);
  });
  document.querySelector(".right-arrow").addEventListener("click", (e) => {
    document.querySelector(".new-message-text #input").focus();
    let length = document.querySelector(".new-message-text #input").value
      .length;
    if (caret_index !== 0) {
      caret_index--; //bitta oldinga
    }
    document
      .querySelector(".new-message-text #input")
      .setSelectionRange(length - caret_index, length - caret_index);
  });

  // FUNNY MODAL
  let joke_shown = 0;
  document.querySelectorAll(".funny_modal_trigger").forEach((funny) => {
    funny.addEventListener("click", () => {
      document.querySelector("#funny_modal").classList.add("active");
      let joke = [
        "AkoüôÑ nima bu sizga haqiqiy telegrammi üòü",
        "Iya, bu knopkani bosib nima qilasiz-eee üòÄ",
        "Ayttim-a shuni bosmaaang, deb ü§¶üèª‚Äç‚ôÇÔ∏è",
        "Ako, keling shu shu knopkani bosmaylik ü•∫",
        "Hisobingizga 100$ tushdi deb tassavur qilamiz üòÅ",
        "Bo'ldi-e, o'ynayvermang klaviturani üò†",
      ];
      let random = Math.floor(Math.random() * (joke.length - 1));
      joke_shown++;
      if (joke_shown === 7) {
        document.querySelector("#funny_modal_text").innerHTML =
          joke[joke.length - 1];
      } else {
        document.querySelector("#funny_modal_text").innerHTML = joke[random];
      }
      setTimeout(
        () => document.querySelector("#funny_modal").classList.remove("active"),
        2000
      );
    });
  });
}

// shift functionality
function shift_func(e) {
  if (!is_shifted) {
    is_shifted = true;
    render_keys(is_shifted, is_cyrillic);
  } else {
    is_shifted = false;
    render_keys(is_shifted, is_cyrillic);
  }
}
// cap functionality
function caps_function(e) {
  document.querySelector(".capsLock").classList.toggle("active");
  if (document.querySelector(".capsLock").classList.contains("active")) {
    document.querySelectorAll(".button").forEach((btn) => {
      btn.style.textTransform = "upperCase";
    });
  } else {
    document.querySelectorAll(".button").forEach((btn) => {
      btn.style.textTransform = "lowerCase";
    });
  }
  is_caps_on = document.querySelector(".capsLock").classList.contains("active");
}
// lang func
function lang_func() {
  if (!is_cyrillic) {
    is_cyrillic = true;
    render_keys(is_shifted, is_cyrillic);
  } else {
    is_cyrillic = false;
    render_keys(is_shifted, is_cyrillic);
  }
}

// /////////////////////////////////MEDIA/////////////////////////////////////////////////
document.querySelector(".back_for_mobile").addEventListener("click", (e) => {
  document
    .querySelector("#telegram")
    .setAttribute("style", "grid-template-columns: 100% 0 0 !important;");
  document.querySelector("#column-left").style.display = "block";
});
